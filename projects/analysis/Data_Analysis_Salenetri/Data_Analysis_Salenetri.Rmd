---
title: "Data_Analysis_Salenetri"
author: "Mia Salenetri"
date: "11/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
#install.packages("tidycensus")
#install.packages("arcos")
#install.packages("tidyverse")
#install.packages("janitor")
#install.packages("scales")
#install.packages("ggrepel")
#install.packages("ggalt")
#install.packages("ggfortify")
#install.packages("gapminder")
```

```{r}
library(tidyverse)
library(tidycensus)
library(arcos)
library(janitor)
library(scales)
library(ggrepel)
library(ggthemes)
library(dplyr)
options(scipen = 0)
library(ggplot2)
library(ggalt)
library(ggfortify)
library(gapminder)
```

```{r}

opioid_deaths_06_12 <- read_tsv("opioid_deaths_06_12.txt")

ruralurbancodes2013 <- read_csv("ruralurbancodes2013.csv")

```

```{r}
ARCOSkey <- "uO4EK6I"
```

Using the nine rural/urban population groups determined by the USDA, I want to determine whether different demographic groups are affected differently based on the size of a metro area.

First, I want to import the datasets I'll need:
 - ARCOS pills per person per county 
 - the USDA rural urban county codes and populations (done)
 - the opioid death rates by county (done)
 - Census demographic data by county for race/ethnicity and economic class 
 
```{r}
options(scipen=999)

#set CENSUSkey
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

acs_variables <- load_variables(2017, "acs5", cache = FALSE)

#load census data
county_geodata <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE)

county_geodata_shifted <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)

state_geodata <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE)

state_geodata_shifted <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)

median_income <- get_acs(geography = "county",
              variables = "B25099_001", geometry = TRUE, shift_geo = TRUE)

race_by_county <- get_acs(geography = "county",
              variables = "B02001_001", geometry = TRUE, shift_geo = TRUE)
```

Instead of working with the differences by year, I want to just use the averages across 2006-12. This means I'll need to alter the ARCOS dataset to show the average amount of pills per person from 2006-12 and the total opioid deaths from 2006-12 by county. Before I've done any work I've noticed that a lot of inputs for "deaths" in opioid_deaths_06_12 are "suppressed." I'm not sure what this means but I assume that I won't have death data for every county. In the end though, I think this won't be an issue as I can use the trends from the counties I do have data for to make an educated guess/inference about that size of metro center.
```{r}
#total number of pills from 2006-2012 categorized by the countyfips code:
arcos_county_pills_per_year <- summarized_county_annual(key = ARCOSkey) %>%
  clean_names()

arcos_county_totals <- arcos_county_pills_per_year %>%
  group_by(countyfips) %>%
  summarise(avg_pills_year = mean(dosage_unit))


```

Join the newly simplified arcos_county_totals with the ruralurbancodes2013 into new rural_urban_working. It will now contain the countyfips, state, county name, population, urban group and pill totals.
```{r}
#changing column names and removing unnecessary columns
rural_urban_working <- ruralurbancodes2013 %>%
  mutate(countyfips = FIPS) %>%
  select(-FIPS) %>%
  select(-Description) %>%
  select(-X7) %>%
  select(-X8) 

#joining the two tables 
rural_urban_working <- rural_urban_working %>%
  inner_join(arcos_county_totals, by = NULL, copy = FALSE)

#adding pills per person column
rural_urban_working <- rural_urban_working %>%
  mutate(Pills_per_person = avg_pills_year/ Population_2010 )

```

I want to attempt to condense the rural_urban_working data and get summaries for the entire group of nine
The two more rural groups and one most urban have the lowest rates of pills per person.
```{r}
rural_urban_condensed <- rural_urban_working %>%
  group_by(RUCC_2013) %>%
  summarise(avg_pills_year=sum(avg_pills_year),
            Total_population=sum(Population_2010)) %>%
  mutate(Pills_per_person = avg_pills_year/ Total_population)

#chart, comparing urbanness/ruralness to pills per person
ggplot(rural_urban_condensed) +
  geom_bar(stat="identity", aes(RUCC_2013, Pills_per_person), fill="pink") +
  labs(x="Size of metro area (most urban to most rural)", y="Pills per person", title="pills per person", subtitle = "subtitle", caption = "caption/source") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous(labels = comma)+
  theme_classic()+
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9))
```

Now, join the census demographic dataset and the USDA population/metro size dataset. Instead of looking at the racial makeup and socioeconomic class for each county, I want to use the median incomes and racial makeups by size of metro area. For example, I want to say that the median household income for a county in a nonmetro area with an urban population of 20,000 or more is X. 
```{r}
median_income <- median_income %>%
  rename(countyfips = GEOID) %>%
  select(-variable)

big_data <- big_data %>%
  inner_join(median_income, by = NULL, copy = FALSE) 

big_data <- big_data %>%
  rename(med_income = estimate)
#join census demographics with USDA population and metro area group
```

While I won't be able to open it on my personal computer, I want to have a massive dataset that is a combination of all the data I could ever need
```{r}
#combine arcos data with USDA (county, state, fips, population, pills/person, rural/urban rank) 
big_data <- rural_urban_working %>%
  group_by(countyfips) 
  

#then add the demographics for each county (race/ethnicity and median income)
#then add optoid deaths for each county
```

Before I do much analysis with the UDSA data, I want to create a color-coded map that visualizes the sizes of metro areas.
```{r}
#create new dataset for usda group map
rural_urban_geo <- county_geodata_shifted %>%
  mutate(countyfips = GEOID) 

#joining with grouping
rural_urban_geo <- rural_urban_geo %>%
  inner_join(rural_urban_working, by = NULL, copy = FALSE)

```

```{r}
#making the MAP itself 
rural_urban_geo_x <- rural_urban_geo %>%
  mutate(RUCC_2013=as.character(RUCC_2013)) %>%
  filter(str_detect(RUCC_2013, "3|4|5|6"))

rural_urban_geo_x %>%
  ggplot(aes(fill = RUCC_2013)) +
  #facet_wrap(~State) +
  geom_sf(lwd = 0) +
  theme_map() +
  labs(fill='Rural to Urban',title="Rural and urban area classifications", subtitle = "USDA, 2013", caption = "Source: USDA") +
  theme(legend.position="right") +
  scale_fill_viridis_d(option = "plasma") 
  

```
 
```{r}
#MAP based on pills per person
rural_urban_geo %>%
  ggplot(aes(fill = Pills_per_person)) +
  geom_sf(lwd = 0) +
  theme_map() +
  labs(fill='PIlls per person',title="Pills per person by US county", subtitle = "", caption = "Source: ARCOS") +
  theme(legend.position="right") +
  scale_fill_viridis_c(option = "plasma",labels = comma)

```

median income map

```{r}
rural_urban_geo_y <- rural_urban_geo %>%
  mutate(RUCC_2013=as.character(RUCC_2013)) %>%
  filter(str_detect(RUCC_2013, "5|7"))

rural_urban_geo_y %>%
  ggplot(aes(fill = estimate)) +
  geom_sf(lwd = 0) +
  theme_map() +
  labs(fill='median income',title="median income by US county", subtitle = "rucc_2013 5 and 7", caption = "Source: bls?") +
  theme(legend.position="right") +
  scale_fill_viridis_c(option = "plasma",labels = comma)

ggplot(rural_urban_geo_y, aes(x=estimate, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="median income vs pills/person by rucc", subtitle = "rucc_2013 5 and 7", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

```

same thing but by 8 & 9
```{r}
rural_urban_geo_y <- rural_urban_geo %>%
  mutate(RUCC_2013=as.character(RUCC_2013)) %>%
  filter(str_detect(RUCC_2013, "8|9"))

ggplot(rural_urban_geo_y, aes(x=estimate, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="median income vs pills/person by rucc", subtitle = "rucc_2013 8 and 9", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

```

does income have anything to do with this? doesnt seem like it ^

LETS LOOK AT HEAVY ALCOHOL USE
```{r}
county_alc_use_heavy <- read_csv("health_data/ALC_USE_HEAVY_2005_2012.csv")

county_alc_use_heavy <- county_alc_use_heavy %>%
  inner_join(rural_urban_working, by = NULL, copy = FALSE)

alc_use_heavy <- county_alc_use_heavy %>%
  select(`State`, `County_Name`, `2006 Both Sexes`, `2007 Both Sexes`, `2008 Both Sexes`, `2009 Both Sexes`, `2010 Both Sexes`, `2011 Both Sexes`, `2012 Both Sexes`, `RUCC_2013`, `countyfips`, `Pills_per_person`) %>%
  mutate(avg_use = rowMeans(select(county_alc_use_heavy, ends_with("Both Sexes")))) %>%
  mutate(RUCC_2013 = as.character(RUCC_2013))%>%
  filter(str_detect(RUCC_2013, "5|7"))

```

lets look at a graph of how heavy alcohol use compares to these other variables
```{r}
glimpse(alc_use_heavy)

ggplot(alc_use_heavy, aes(x=avg_use, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="heavy alcohol use vs pills/person by rucc", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

```

looks like heavy alcohol use also has nothing to do with pills/person

okayyyy in a perfect world i would be looking at unemployment data next but i cant get the formatting right and i give up
```{r}


```











