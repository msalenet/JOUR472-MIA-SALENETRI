---
title: "Data_Analysis_Salenetri"
author: "Mia Salenetri"
date: "11/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
#install.packages("tidycensus")
#install.packages("arcos")
#install.packages("tidyverse")
#install.packages("janitor")
#install.packages("scales")
#install.packages("ggrepel")
#install.packages("ggalt")
#install.packages("ggfortify")
#install.packages("gapminder")
```

```{r}
library(tidyverse)
library(tidycensus)
library(arcos)
library(janitor)
library(scales)
library(ggrepel)
library(ggthemes)
library(dplyr)
options(scipen = 0)
library(ggplot2)
library(ggalt)
library(ggfortify)
library(gapminder)
library(readxl)
library(reprex)
```

```{r}

opioid_deaths_06_12 <- read_tsv("opioid_deaths_06_12.txt")

ruralurbancodes2013 <- read_csv("ruralurbancodes2013.csv")

```

```{r}
ARCOSkey <- "uO4EK6I"
```

Using the nine rural/urban population groups determined by the USDA, I want to determine whether different demographic groups are affected differently based on the size of a metro area.

First, I want to import the datasets I'll need:
 - ARCOS pills per person per county 
 - the USDA rural urban county codes and populations (done)
 - the opioid death rates by county (done)
 - Census demographic data by county for race/ethnicity and economic class 
 
```{r}
options(scipen=999)

#set CENSUSkey
census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

acs_variables <- load_variables(2017, "acs5", cache = FALSE)

#load census data
county_geodata <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE)

county_geodata_shifted <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)

state_geodata <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE)

state_geodata_shifted <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE, shift_geo = TRUE)

median_income <- get_acs(geography = "county",
              variables = "B25099_001", geometry = TRUE, shift_geo = TRUE)

race_by_county <- get_acs(geography = "county",
              variables = "B02001_001", geometry = TRUE, shift_geo = TRUE)
```

Instead of working with the differences by year, I want to just use the averages across 2006-12. This means I'll need to alter the ARCOS dataset to show the average amount of pills per person from 2006-12 and the total opioid deaths from 2006-12 by county. Before I've done any work I've noticed that a lot of inputs for "deaths" in opioid_deaths_06_12 are "suppressed." I'm not sure what this means but I assume that I won't have death data for every county. In the end though, I think this won't be an issue as I can use the trends from the counties I do have data for to make an educated guess/inference about that size of metro center.
```{r}
#total number of pills from 2006-2012 categorized by the countyfips code:
arcos_county_pills_per_year <- summarized_county_annual(key = ARCOSkey) %>%
  clean_names()

arcos_county_totals <- arcos_county_pills_per_year %>%
  group_by(countyfips) %>%
  summarise(avg_pills_year = mean(dosage_unit))


```

Join the newly simplified arcos_county_totals with the ruralurbancodes2013 into new rural_urban_working. It will now contain the countyfips, state, county name, population, urban group and pill totals.
```{r}
#changing column names and removing unnecessary columns
rural_urban_working <- ruralurbancodes2013 %>%
  mutate(countyfips = FIPS) %>%
  select(-FIPS) %>%
  select(-Description) %>%
  select(-X7) %>%
  select(-X8) 

#joining the two tables 
rural_urban_working <- rural_urban_working %>%
  inner_join(arcos_county_totals, by = NULL, copy = FALSE)

#adding pills per person column
rural_urban_working <- rural_urban_working %>%
  mutate(Pills_per_person = avg_pills_year/ Population_2010 )

```

I want to attempt to condense the rural_urban_working data and get summaries for the entire group of nine
The two more rural groups and one most urban have the lowest rates of pills per person.
```{r}
rural_urban_condensed <- rural_urban_working %>%
  group_by(RUCC_2013) %>%
  summarise(avg_pills_year=sum(avg_pills_year),
            Total_population=sum(Population_2010)) %>%
  mutate(Pills_per_person = avg_pills_year/ Total_population)

#chart, comparing urbanness/ruralness to pills per person
ggplot(rural_urban_condensed) +
  geom_bar(stat="identity", aes(RUCC_2013, Pills_per_person), fill="pink") +
  labs(x="Size of metro area (most urban to most rural)", y="Pills per person", title="pills per person", subtitle = "subtitle", caption = "caption/source") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_y_continuous(labels = comma)+
  theme_classic()+
  scale_x_continuous(breaks = c(1,2,3,4,5,6,7,8,9))
```

Now, join the census demographic dataset and the USDA population/metro size dataset. Instead of looking at the racial makeup and socioeconomic class for each county, I want to use the median incomes and racial makeups by size of metro area. For example, I want to say that the median household income for a county in a nonmetro area with an urban population of 20,000 or more is X. 
```{r}
#median_income <- median_income %>%
#  rename(countyfips = GEOID) %>%
#  select(-variable)

#big_data <- big_data %>%
#  inner_join(median_income, by = NULL, copy = FALSE) 

#big_data <- big_data %>%
#  rename(med_income = estimate)
#join census demographics with USDA population and metro area group
```

While I won't be able to open it on my personal computer, I want to have a massive dataset that is a combination of all the data I could ever need
```{r}
#combine arcos data with USDA (county, state, fips, population, pills/person, rural/urban rank) 
big_data <- rural_urban_working %>%
  group_by(countyfips) %>%
  mutate(RUCC_2013 = as.character(RUCC_2013))
  

#then add the demographics for each county (race/ethnicity and median income)
#then add optoid deaths for each county
```

Before I do much analysis with the UDSA data, I want to create a color-coded map that visualizes the sizes of metro areas.
```{r}
#create new dataset for usda group map
county_geodata_shifted <- county_geodata_shifted %>%
  mutate(countyfips = GEOID)

rural_urban_geo <- county_geodata_shifted %>%
  mutate(countyfips = GEOID) 

#joining with grouping
rural_urban_geo <- rural_urban_geo %>%
  inner_join(rural_urban_working, by = NULL, copy = FALSE)

```

```{r}
#making the MAP itself 
rural_urban_geo_x <- rural_urban_geo %>%
  mutate(RUCC_2013=as.character(RUCC_2013)) %>%
  filter(str_detect(RUCC_2013, "3|4|5|6"))

rural_urban_geo_x %>%
  ggplot(aes(fill = RUCC_2013)) +
  #facet_wrap(~State) +
  geom_sf(lwd = 0) +
  theme_map() +
  labs(fill='Rural to Urban',title="Rural and urban area classifications", subtitle = "USDA, 2013", caption = "Source: USDA") +
  theme(legend.position="right") +
  scale_fill_viridis_d(option = "plasma") 
  

```
 
```{r}
#MAP based on pills per person
rural_urban_geo %>%
  ggplot(aes(fill = Pills_per_person)) +
  geom_sf(lwd = 0) +
  theme_map() +
  labs(fill='PIlls per person',title="Pills per person by US county", subtitle = "", caption = "Source: ARCOS") +
  theme(legend.position="right") +
  scale_fill_viridis_c(option = "plasma",labels = comma)

```

median income map

```{r}
rural_urban_geo_y <- rural_urban_geo %>%
  mutate(RUCC_2013=as.character(RUCC_2013)) %>%
  filter(str_detect(RUCC_2013, "5|7"))

rural_urban_geo_y %>%
  ggplot(aes(fill = estimate)) +
  geom_sf(lwd = 0) +
  theme_map() +
  labs(fill='median income',title="median income by US county", subtitle = "rucc_2013 5 and 7", caption = "Source: bls?") +
  theme(legend.position="right") +
  scale_fill_viridis_c(option = "plasma",labels = comma)

ggplot(rural_urban_geo_y, aes(x=estimate, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="median income vs pills/person by rucc", subtitle = "rucc_2013 5 and 7", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

```

same thing but by 8 & 9
```{r}
rural_urban_geo_y <- rural_urban_geo %>%
  mutate(RUCC_2013=as.character(RUCC_2013)) %>%
  filter(str_detect(RUCC_2013, "8|9"))

ggplot(rural_urban_geo_y, aes(x=estimate, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="median income vs pills/person by rucc", subtitle = "rucc_2013 8 and 9", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

```

does income have anything to do with this? doesnt seem like it ^

LETS LOOK AT HEAVY ALCOHOL USE
```{r}
county_alc_use_heavy <- read_csv("health_data/ALC_USE_HEAVY_2005_2012.csv")

county_alc_use_heavy <- county_alc_use_heavy %>%
  inner_join(rural_urban_working, by = NULL, copy = FALSE)

alc_use_heavy <- county_alc_use_heavy %>%
  select(`State`, `County_Name`, `2006 Both Sexes`, `2007 Both Sexes`, `2008 Both Sexes`, `2009 Both Sexes`, `2010 Both Sexes`, `2011 Both Sexes`, `2012 Both Sexes`, `RUCC_2013`, `countyfips`, `Pills_per_person`) %>%
  mutate(avg_use = rowMeans(select(county_alc_use_heavy, ends_with("Both Sexes")))) %>%
  mutate(RUCC_2013 = as.character(RUCC_2013))%>%
  filter(str_detect(RUCC_2013, "5|7"))

```

lets look at a graph of how heavy alcohol use compares to these other variables
```{r}
glimpse(alc_use_heavy)

ggplot(alc_use_heavy, aes(x=avg_use, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="heavy alcohol use vs pills/person by rucc", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

```

looks like heavy alcohol use also has nothing to do with pills/person

break it down by gender, get the averages
```{r}
county_alc_use_heavy <- county_alc_use_heavy %>%
  select(-`Percent Change 2005-2012, Both Sexes`, -`Percent Change 2005-2012, Females`, -`Percent Change 2005-2012, Males`) %>%
  mutate(avg_use_male = rowMeans(select(county_alc_use_heavy, ends_with("Males")))) %>%
  mutate(avg_use_female = rowMeans(select(county_alc_use_heavy, ends_with("Females")))) %>%
  mutate(avg_use = rowMeans(select(county_alc_use_heavy, ends_with("Both Sexes")))) %>%
  mutate(RUCC_2013 = as.character(RUCC_2013))%>%
  filter(str_detect(RUCC_2013, "5|7"))
```

graph the averages for male & female heavy drinking
```{r}
ggplot(county_alc_use_heavy, aes(x=avg_use_male, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="heavy alcohol use by males vs pills/person by rucc", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

ggplot(county_alc_use_heavy, aes(x=avg_use_female, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="heavy alcohol use by females vs pills/person by rucc", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

```

make a clean, basic alc use frame of just averages
```{r}
alc_use_clean <- read_csv("health_data/ALC_USE_HEAVY_2005_2012.csv")

alc_use_clean <- alc_use_clean %>%
  inner_join(rural_urban_working, by = NULL, copy = FALSE) 

alc_use_clean <- alc_use_clean %>%
  select(-`Percent Change 2005-2012, Both Sexes`, -`Percent Change 2005-2012, Females`, -`Percent Change 2005-2012, Males`) %>%
  mutate(avg_use_male = rowMeans(select(alc_use_clean, ends_with("Males")))) %>%
  mutate(avg_use_female = rowMeans(select(alc_use_clean, ends_with("Females")))) %>%
  mutate(avg_use = rowMeans(select(alc_use_clean, ends_with("Both Sexes")))) %>%
  mutate(RUCC_2013 = as.character(RUCC_2013))

alc_use_clean <- alc_use_clean %>%
  select(countyfips, avg_use_male, avg_use_female, avg_use)

```

looking at unemployment data next! input it all and then make one massive frame with all the unemployment rates
```{r}
unemployment06 <- read_xlsx("BLS_data/laucnty06.xlsx") %>%
  mutate(countyfips = paste0(state_fips,county_fips)) %>%
  rename('2006_rate' = 'unemployment_rate') %>%
  select(-LAUS, -state_fips, -county_fips, -...6)

unemployment07 <- read_xlsx("BLS_data/laucnty07.xlsx") %>%
  mutate(countyfips = paste0(state_fips,county_fips)) %>%
  rename('2007_rate' = 'unemployment_rate') %>%
  select(-LAUS, -state_fips, -county_fips)

unemployment08 <- read_xlsx("BLS_data/laucnty08.xlsx") %>%
  mutate(countyfips = paste0(state_fips,county_fips)) %>%
  rename('2008_rate' = 'unemployment_rate') %>%
  select(-LAUS, -state_fips, -county_fips)

unemployment09 <- read_xlsx("BLS_data/laucnty09.xlsx") %>%
  mutate(countyfips = paste0(state_fips,county_fips)) %>%
  rename('2009_rate' = 'unemployment_rate') %>%
  select(-LAUS, -state_fips, -county_fips)

unemployment10 <- read_xlsx("BLS_data/laucnty10.xlsx") %>%
  mutate(countyfips = paste0(state_fips,county_fips)) %>%
  rename('2010_rate' = 'unemployment_rate') %>%
  select(-LAUS, -state_fips, -county_fips)

unemployment11 <- read_xlsx("BLS_data/laucnty11.xlsx") %>%
  mutate(countyfips = paste0(state_fips,county_fips)) %>%
  rename('2011_rate' = 'unemployment_rate') %>%
  select(-LAUS, -state_fips, -county_fips)

unemployment12 <- read_xlsx("BLS_data/laucnty12.xlsx") %>%
  mutate(countyfips = paste0(state_fips,county_fips)) %>%
  rename('2012_rate' = 'unemployment_rate') %>%
  select(-LAUS, -state_fips, -county_fips)

#tried making a blank data frame, didn't help
#unemployment_all <- data.frame(county_name=character(), 
                               #fips=character(), 
                               #stringsAsFactors=FALSE) 
```

adding all the unemployment rates into one frame
```{r}

unemployment_all <- unemployment06 %>%
  select(-year, -labor_force, -employed, -unemployed) 

unemployment_all <- unemployment_all %>%
  full_join(unemployment07, by = NULL, copy = FALSE) %>%
  select(-year, -labor_force, -employed, -unemployed)
unemployment_all <- unemployment_all %>%
  full_join(unemployment08, by = NULL, copy = FALSE) %>%
  select(-year, -labor_force, -employed, -unemployed)
unemployment_all <- unemployment_all %>%
  full_join(unemployment09, by = NULL, copy = FALSE) %>%
  select(-year, -labor_force, -employed, -unemployed)
unemployment_all <- unemployment_all %>%
  full_join(unemployment10, by = NULL, copy = FALSE) %>%
  select(-year, -labor_force, -employed, -unemployed)
unemployment_all <- unemployment_all %>%
  full_join(unemployment11, by = NULL, copy = FALSE) %>%
  select(-year, -labor_force, -employed, -unemployed)
unemployment_all <- unemployment_all %>%
  full_join(unemployment12, by = NULL, copy = FALSE) %>%
  select(-year, -labor_force, -employed, -unemployed)
```
combine the unemployment data w everything else & graph it
how do i find whats statistically signifigant?
```{r}
unemployment_all <- unemployment_all %>%
  inner_join(big_data, by = NULL, copy = FALSE) %>%
  select(-State, -County_Name) 

unemployment_all <- unemployment_all %>%
  mutate(avg_unemployment = rowMeans(select(unemployment_all, ends_with("_rate")))) %>%
  mutate(RUCC_2013 = as.character(RUCC_2013))

#plot of all groups
ggplot(unemployment_all, aes(x=avg_unemployment, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="avg unemployment from 2006-2012 vs pills/person by rucc", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

#plot of biggest urban areas
unemployment_all_x <- unemployment_all%>%
  filter(str_detect(RUCC_2013, "1|2|3"))

ggplot(unemployment_all_x, aes(x=avg_unemployment, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="avg unemployment from 2006-2012 vs pills/person by rucc", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

#plot of mid-sized
unemployment_all_y <- unemployment_all%>%
  filter(str_detect(RUCC_2013, "4|5|6"))

ggplot(unemployment_all_y, aes(x=avg_unemployment, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="avg unemployment from 2006-2012 vs pills/person by rucc", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

#plot of smallest
unemployment_all_z <- unemployment_all%>%
  filter(str_detect(RUCC_2013, "7|8|9"))

ggplot(unemployment_all_z, aes(x=avg_unemployment, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="avg unemployment from 2006-2012 vs pills/person by rucc", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)
```

graph the relationships between unemployment & everything else


```{r}

```

move onto life expectancy 
clean it up
```{r}
life_expectancy <- read_xlsx('health_data/LIFE_EXPECTANCY_2005_2014.xlsx') %>%
  clean_names() %>%
  separate(life_expectancy_2005, sep=" \\(", into=c("life_expectancy_2005", "2005_garbage") ) %>%
  mutate(life_expectancy_2005 = as.numeric(life_expectancy_2005)) %>%
  separate(life_expectancy_2010, sep=" \\(", into=c("life_expectancy_2010", "2010_garbage") ) %>%
  mutate(life_expectancy_2010 = as.numeric(life_expectancy_2010)) %>%
  separate(life_expectancy_2014, sep=" \\(", into=c("life_expectancy_2014", "2014_garbage") ) %>%
  mutate(life_expectancy_2014 = as.numeric(life_expectancy_2014)) %>%
  select(-'2005_garbage', -'2010_garbage', -'2014_garbage', -'percent_change_in_life_expectancy_1980_2014') %>%
  mutate(fips = as.numeric(fips)) %>%
  mutate(fips = case_when(fips < 10000 ~ paste0("0", fips ),
                           TRUE ~ as.character(fips))
         )

life_expectancy <- life_expectancy %>%
  mutate(avg_expectancy = rowMeans(select(life_expectancy, starts_with("life_"))))
```

combine with location data so we can map it
```{r}
life_expectancy <- life_expectancy %>%
  rename(countyfips=fips) %>%
  inner_join(county_geodata_shifted, by=NULL, copy=FALSE) 
```

i'm getting an error here
life_expectancy %>%
  ggplot(aes(fill = avg_expectancy)) +
  geom_sf(lwd = 0) +
  theme_map() +
  labs(fill='life expectancy',title="life expectancy by US county", subtitle = "", caption = "Source: health data") +
  theme(legend.position="right") +
  scale_fill_viridis_c(option = "plasma",labels = comma)

make sure all the newly imported data points are in big_data
```{r}
#life expectancy
big_data <- big_data %>%
  full_join(life_expectancy, by=NULL, copy=FALSE) %>%
  select(State, County_Name, Population_2010, RUCC_2013, countyfips, avg_pills_year, Pills_per_person, avg_expectancy)

#unemployment
big_data <- big_data %>%
  inner_join(unemployment_all, by='countyfips', copy=TRUE) %>%
  select(State, County_Name, Population_2010.x, RUCC_2013.x, countyfips, avg_pills_year.x, Pills_per_person.x, avg_expectancy, avg_unemployment) 

big_data <- big_data %>%
  rename(Population_2010 = Population_2010.x) %>%
  rename(RUCC_2013 = RUCC_2013.x) %>%
  rename(avg_pills_year = avg_pills_year.x) %>%
  rename(Pills_per_person = Pills_per_person.x)

#heavy alcohol use
big_data <- big_data %>%
  inner_join(alc_use_clean, by=NULL, copy=FALSE)

glimpse(big_data)
```

ok graph as many things as possible to find something
```{r}
#alcohol uses versus pills:
ggplot(big_data, aes(x=avg_use_female, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="title", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

ggplot(big_data, aes(x=avg_use_male, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="title", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

ggplot(big_data, aes(x=avg_use, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="title", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)
```
```{r}
#life expectancy versus:
ggplot(big_data, aes(x=avg_expectancy, y=Pills_per_person, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="title", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

ggplot(big_data, aes(x=avg_expectancy, y=avg_unemployment, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="title", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)

ggplot(big_data, aes(x=avg_expectancy, y=avg_use, shape=RUCC_2013, color=RUCC_2013)) + 
  geom_point() +
  labs(title="title", subtitle = "", caption = "Source: bls, etc?") +
  geom_smooth(method=lm)
```
















